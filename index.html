<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Storyline Highlighter – Fixed 1276×1790</title>

<style>
  :root { --toolbar-h: 54px; }

  * { box-sizing: border-box; }

  /* Kill scrollbars at every level */
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden !important;
    background: transparent;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }

  body { position: relative; }

  .viewport {
    position: fixed;
    inset: 0;
    overflow: hidden !important;
    background: transparent;
  }

  /* Toolbar */
  .toolbar{
    position: absolute;
    top: 0; left: 0; right: 0;
    height: var(--toolbar-h);
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.96);
    border-bottom: 1px solid #e4e4e4;
    z-index: 10;
  }

  button{
    padding: 6px 10px;
    border: 1px solid #cfcfcf;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 14px;
  }
  button.active{
    border-color:#333;
    box-shadow: inset 0 0 0 2px #3332;
  }

  /* Content area BELOW toolbar */
  .content{
    position: absolute;
    top: var(--toolbar-h);
    left: 0; right: 0; bottom: 0;
    overflow: hidden !important;
    background: transparent;
  }

  /* Scaled wrapper */
  .stageWrap{
    position: absolute;
    left: 50%;
    top: 0;
    transform-origin: top center;
    will-change: transform;
  }

  /* Fixed design stage (Storyline size) */
  .stage{
    position: relative;
    width: 1276px;
    height: 1790px;
    overflow: hidden;
    background: transparent;
  }

  /* IMPORTANT: lock background to exact pixel size + top-left */
  .page{
    position: absolute;
    inset: 0;
    background-image: url("S5U7L1-01.png");
    background-repeat: no-repeat;
    background-position: 0 0;             /* top-left */
    background-size: 1276px 1790px;       /* exact pixels */
    z-index: 0;
  }

  canvas{
    position: absolute;
    inset: 0;
    width: 1276px;
    height: 1790px;
    background: transparent;
    z-index: 1;
    touch-action: none;
  }
</style>
</head>

<body>
<div class="viewport">
  <div class="toolbar">
    <button id="penBtn" class="active">Pen</button>
    <button id="hlBtn">Highlighter</button>
    <button id="eraserBtn">Eraser</button>
    <button id="clearBtn">Clear</button>
  </div>

  <div class="content" id="content">
    <div class="stageWrap" id="stageWrap">
      <div class="stage">
        <div class="page"></div>
        <canvas id="board" width="1276" height="1790"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  const DESIGN_W = 1276;
  const DESIGN_H = 1790;

  const content   = document.getElementById("content");
  const stageWrap = document.getElementById("stageWrap");
  const canvas    = document.getElementById("board");
  const ctx       = canvas.getContext("2d");

  const penBtn    = document.getElementById("penBtn");
  const hlBtn     = document.getElementById("hlBtn");
  const eraserBtn = document.getElementById("eraserBtn");
  const clearBtn  = document.getElementById("clearBtn");

  let mode = "pen";
  let drawing = false;
  let scale = 1;

  function fitStage(){
    const cw = content.clientWidth;
    const ch = content.clientHeight;

    // Fit to available space (no overflow)
    scale = Math.min(cw / DESIGN_W, ch / DESIGN_H);

    // If Storyline gives tiny fractional sizes, clamp to avoid 1px overflow
    scale = Math.floor(scale * 10000) / 10000;

    stageWrap.style.transform = `translateX(-50%) scale(${scale})`;
    stageWrap.style.width = DESIGN_W + "px";
    stageWrap.style.height = DESIGN_H + "px";
  }

  window.addEventListener("resize", fitStage);
  fitStage();

  function setMode(m){
    mode = m;
    penBtn.classList.toggle("active", m === "pen");
    hlBtn.classList.toggle("active", m === "highlighter");
    eraserBtn.classList.toggle("active", m === "eraser");
  }

  ctx.lineCap = "round";
  ctx.lineJoin = "round";

  function getPoint(e){
    const rect = canvas.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;

    const xCss = clientX - rect.left;
    const yCss = clientY - rect.top;

    // Map back to design coordinates
    return { x: xCss / scale, y: yCss / scale };
  }

  function start(e){
    drawing = true;
    ctx.beginPath();
    const {x,y} = getPoint(e);
    ctx.moveTo(x,y);
  }

  function draw(e){
    if(!drawing) return;

    if(mode === "pen"){
      ctx.globalCompositeOperation = "source-over";
      ctx.lineWidth = 2.5;
      ctx.strokeStyle = "#111";
    } else if(mode === "highlighter"){
      ctx.globalCompositeOperation = "multiply";
      ctx.lineWidth = 18;
      ctx.strokeStyle = "rgba(255,255,0,0.15)";
    } else if(mode === "eraser"){
      ctx.globalCompositeOperation = "destination-out";
      ctx.lineWidth = 22;
      ctx.strokeStyle = "rgba(0,0,0,1)";
    }

    const {x,y} = getPoint(e);
    ctx.lineTo(x,y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x,y);
  }

  function end(){
    drawing = false;
    ctx.beginPath();
    ctx.globalCompositeOperation = "source-over";
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", draw);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", (e)=>{ e.preventDefault(); start(e); }, {passive:false});
  canvas.addEventListener("touchmove",  (e)=>{ e.preventDefault(); draw(e);  }, {passive:false});
  canvas.addEventListener("touchend",   (e)=>{ e.preventDefault(); end();    }, {passive:false});

  penBtn.onclick    = ()=>setMode("pen");
  hlBtn.onclick     = ()=>setMode("highlighter");
  eraserBtn.onclick = ()=>setMode("eraser");
  clearBtn.onclick  = ()=>ctx.clearRect(0,0,DESIGN_W,DESIGN_H);

  setMode("pen");

  // Extra: run fit again after a short delay (Storyline sometimes sizes iframe late)
  setTimeout(fitStage, 50);
  setTimeout(fitStage, 300);
</script>
</body>
</html>
